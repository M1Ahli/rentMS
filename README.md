# نظام إدارة العقارات والعقود (Property Management System)

نسخة مُعاد هيكلتها من مشروعك الأصلي (HTML واحد كبير) بهدف **تسهيل الصيانة والتطوير** بدون كسر الوظائف.

**الإصدار الحالي:** UIV31  
**تاريخ الحزمة:** 2026-01-22

---

## فكرة النظام باختصار
نظام إدارة عقارات وعقود يعمل محليًا على المتصفح (Offline-first) بدون سيرفر قاعدة بيانات، ويعتمد على:
- **localStorage** للتخزين
- **استيراد/تصدير JSON** كنسخ احتياطية

---

## التشغيل السريع
> مهم: لا تفتح الملفات مباشرة بـ `file://` لأن المشروع يستخدم `fetch()` لتحميل الصفحات/المكونات.

### خيار 1: Live Server (مُوصى به)
- افتح المجلد في VS Code
- شغّل **Live Server**
- افتح: `http://127.0.0.1:5500/index.html`

### خيار 2: Python HTTP Server
داخل مجلد المشروع:
- Windows:
  - `py -m http.server 8080`
- macOS/Linux:
  - `python3 -m http.server 8080`
ثم افتح: `http://127.0.0.1:8080/index.html`

> إذا لم تظهر التغييرات بعد تحديث نسخة: اعمل **Hard Refresh**: `Ctrl + F5`

---

## هيكل المجلدات
- `index.html` : نقطة الدخول
- `pages/` : صفحات النظام (Dashboard / عقود / عقارات / ... إلخ)
- `components/` : مكونات مشتركة (Header / Sidebar / Modals)
- `assets/css/app.css` : **CSS واحد** موحّد (لتفادي تداخل ستايلات قديمة/جديدة)
- `assets/js/bootstrap.js` : محمّل الصفحات + ترتيب تحميل سكربتات التطبيق
- `assets/js/ui_unified.js` : توحيد عناصر الواجهة (Toolbars/Modals/Buttons)
- `assets/js/app/` : سكربتات التطبيق بعد إعادة الهيكلة (Modules)
- `assets/js/legacy/app_legacy_full.js` : نسخة مرجعية من السكربت القديم للرجوع عند الحاجة
- `tools/` : أدوات مساعدة (بناء نسخة ملف واحد)

---

## الصفحات الأساسية
- لوحة المعلومات: `dashboard`
- العقارات والوحدات: `properties`
- العقود: `leases`
- **أرشيف العقود**: `leases-archive`  ✅
- المستأجرون: `tenants`
- الدفعات: `payments`
- الشيكات: `cheques`
- المصروفات: `expenses`
- الرواتب: `salaries`
- الإيصالات وسجل الإيصالات: `receipts`, `receipts-history`
- التقارير: `reports`
- الإنذارات/الإشعارات + الطباعة: `notices`
- الإعدادات: `settings`

---

## التخزين والنسخ الاحتياطي
- البيانات تُحفظ في **localStorage**.
- من صفحة **الإعدادات** يمكنك:
  - **تصدير JSON** (Backup)
  - **استيراد JSON** (Restore)

> ملاحظة: الاستيراد يستبدل البيانات الحالية (بحسب إعدادات المشروع).

---

## أهم الميزات التي تم تثبيتها في هذه السلسلة

### 1) توحيد الواجهة (UI)
- توحيد شريط البحث/الفرز في الصفحات الرئيسية عبر `ui-toolbar`.
- توحيد الجداول وأزرار الإجراءات داخلها.
- توحيد المودالات (Scroll + إغلاق + محاذاة) عبر قالب واحد.

### 2) الطباعة (A4)
- طباعة الإنذارات بتنسيق **عمودين** (عربي يمين + إنجليزي يسار).
- ضبط أبعاد الصفحة (A4) والهوامش للطباعة.
- فصل طباعة السندات عن طباعة الإنذارات (لكلٍ سياقه الخاص).

### 3) أرشيف العقود (يدوي فقط)
- صفحة جديدة: **أرشيف العقود**
- لا يتم أرشفة العقد لمجرد أن تاريخه انتهى.
- الأرشفة تحدث فقط عند:
  - **تجديد عقد** (يحفظ العقد السابق)
  - **إلغاء/إخلاء** عبر زر الأرشفة
- الأرشيف يعرض فقط السجلات التي تحتوي على:
  - **سبب الأرشفة** (تجديد / إلغاء / إخلاء)
  - **ملاحظة**
  - **تاريخ الأرشفة**
- يوجد زر **إلغاء الأرشفة** داخل الأرشيف (يحذف السجل من الأرشيف فقط).

### 4) جدولة الدفعات/الشيكات عند إنشاء/تجديد العقد ✅
عند إضافة أو تجديد عقد، وبعد اختيار **عدد الدفعات** أو **عدد الشيكات**:
- يمكنك تفعيل خيار:
  - **إنشاء سجل دفعات (بانتظار الدفع)**
  - **إنشاء سجل شيكات (بانتظار الصرف)**
- يتم إدخال:
  - مبلغ كل دفعة/شيك
  - تاريخ الاستحقاق
  - تفاصيل إضافية (ملاحظة/بنك/رقم شيك)

#### حالة السجلات
- الدفعات المجدولة تُحفظ: **بانتظار الدفع**
- الشيكات المجدولة تُحفظ: **بانتظار الصرف**  
  (تم إصلاح خطأ كان يظهرها “مصروف” بالخطأ)

#### “تسجيل” الدفعة لاحقًا
- في صفحة **الدفعات** ستجد زر **تسجيل** بجانب الدفعة المعلقة:
  - يفتح نموذج التسجيل ويحوّلها إلى مدفوعة **بتحديث نفس السجل** (بدون إنشاء سجل جديد).

### 5) عقود متعددة الوحدات – توزيع الدفعات
- خيار توزيع الدفعات يعمل بشكل صحيح.
- عند تعديل مبلغ الدفعة: يتم **إعادة حساب التوزيع تلقائيًا** (ما لم تبدأ تعديلات يدوية للتوزيع).

### 6) التقسيم بأرقام كاملة (بدون كسور) ✅
- تقسيم الدفعات/الشيكات يتم بأرقام صحيحة AED.
- إذا لم ينقسم المبلغ بالتساوي:
  - يتم توزيع الفارق (+1) على أول البنود لضمان أن **المجموع النهائي يطابق المبلغ الأصلي 100%**.
- نفس المنطق يُستخدم عند توزيع الدفعة على وحدات العقد.

---

## تعديل/تطوير سريع (أين أعدل؟)
- واجهة عامة + الثيم + توحيد عناصر UI:
  - `assets/css/app.css`
  - `assets/js/ui_unified.js`
- العقارات/الوحدات:
  - `assets/js/app/04_properties.js`
- العقود + التجديد + الأرشفة + تعدد الوحدات:
  - `assets/js/app/05_leases.js`
- الدفعات + توزيع الدفعات:
  - `assets/js/app/07_payments.js`
- الشيكات:
  - `assets/js/app/08_cheques.js`
- الإنذارات والطباعة:
  - `assets/js/app/02_notices_health.js`

---

## بناء نسخة “ملف واحد” (اختياري)
يوجد سكربت بناء داخل:
- `tools/build_single.py`
ينتج نسخة ضمن `dist/` للاستخدام كصفحة واحدة عند الحاجة.

---

## ملاحظات
- إذا ظهرت مشكلة عرض بعد تحديث نسخة: جرّب **Hard Refresh** (Ctrl+F5).
- يفضّل تشغيل المشروع عبر localhost (Live Server / Python server) لتجنّب مشاكل `fetch()`.

---
**تم تحديث هذا الملف ليتوافق مع UIV31.**
