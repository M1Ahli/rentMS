# نظام إدارة العقارات والعقود (Property Management System)

نسخة مُعاد هيكلتها من مشروعك الأصلي (ملف HTML واحد كبير) بهدف **تسهيل الصيانة والتطوير** بدون كسر الوظائف (الحفاظ على نفس الـ IDs / نفس الدوال المستخدمة في الواجهة / نفس منطق التنقل).

**الإصدار الحالي:** UIV18  
**ملخص التحديثات الأهم في هذه السلسلة:**
- تقسيم المشروع إلى **Pages/Components/Assets** مع تحميل ديناميكي عبر `bootstrap.js`.
- توحيد/تنظيف الستايل (ملف CSS واحد) + تحسينات Dark Mode للأزرار/الجداول/الحقول.
- تحسين طباعة الإنذارات (Arabic + English) بتنسيق **عمودين** + ضبط **Margins** للطباعة.
- **توحيد شريط البحث/الفرز** في الصفحات الرئيسية عبر مكوّن UI موحّد `ui-toolbar` (العقود/المستأجرين/الشيكات/المصروفات/سجل الإيصالات/العقارات).
- إصلاحات وظيفية: **تعديل العقد** (منع ReferenceError) + **تعديل الوحدة** (إغلاق المودال بعد الحفظ + تفعيل Scroll داخل المودال).

---

## 1) ملخص الموقع (ماذا يفعل النظام؟)
الموقع عبارة عن لوحة إدارة (Admin Dashboard) لإدارة عقاراتك ووحداتك وعقود الإيجار وعمليات التحصيل، ويشمل صفحات/وحدات رئيسية:

- **Dashboard**: مؤشرات سريعة (إيرادات/مصروفات/عقود فعالة/متأخرات… إلخ حسب البيانات).
- **العقارات والوحدات (Properties & Units)**: إضافة/تعديل العقارات والوحدات، عرض الوحدات وبياناتها.
- **العقود (Leases)**: إدارة العقود، متابعة الانتهاء والتجديد، بيانات العقد والقيمة.
- **المستأجرين (Tenants)**: ملف المستأجر وربطه بالعقود/الوحدات.
- **الشيكات والمدفوعات (Cheques & Payments)**: تسجيل شيكات/دفعات، حالات التحصيل، المتأخرات.
- **المصروفات والرواتب (Expenses & Salaries)**: توثيق المصروفات والرواتب.
- **الإيصالات (Receipt + Receipts History)**: إنشاء إيصال + سجل الإيصالات.
- **التقارير (Reports)**: تقارير تلخيصية بحسب البيانات.
- **الإنذارات/الإشعارات (Notices)**: إنشاء/معاينة/طباعة إنذارات (ثنائي اللغة).
- **الإعدادات والنسخ الاحتياطي (Settings + Backup)**: استيراد/تصدير البيانات، إعدادات عامة.

> **النظام Offline‑first**: يعمل بدون سيرفر وبدون قاعدة بيانات خارجية — يعتمد على التخزين المحلي للمتصفح.

---

## 2) التقنيات المستخدمة
- **HTML + Tailwind (CDN)** لواجهة سريعة ودعم RTL.
- **CSS موحّد** داخل: `assets/css/app.css` (قاعدة العمل: أي تعديل بصري يكون هنا فقط لتفادي تداخل ستايلات متعددة).
- **JavaScript Vanilla** داخل: `assets/js/app.js` (منطق CRUD + Rendering + Backup + Print).
- تحميل صفحات/مكونات HTML ديناميكيًا عبر `fetch()` من خلال: `assets/js/bootstrap.js`.

---

## 3) هيكل المجلدات (Architecture)

```
.
├─ index.html
├─ components/
│  ├─ nav.html            # شريط التنقل العلوي (Tabs)
│  └─ modals.html         # كل النوافذ المنبثقة (Modals)
├─ pages/                 # كل صفحة/عرض (View) كملف مستقل
│  ├─ dashboard.html
│  ├─ properties.html
│  ├─ leases.html
│  ├─ tenants.html
│  ├─ cheques.html
│  ├─ payments.html
│  ├─ expenses.html
│  ├─ salaries.html
│  ├─ receipts-history.html
│  ├─ receipt.html
│  ├─ reports.html
│  ├─ notices.html
│  └─ settings.html
├─ assets/
│  ├─ css/
│  │  └─ app.css          # ستايل موحّد + Dark Mode + Print
│  └─ js/
│     ├─ bootstrap.js     # يحمّل components/pages ثم يحمّل app.js
│     ├─ app.js           # منطق النظام
│     ├─ router.js        # hash routing (اختياري)
│     ├─ dev-tools.js     # تشخيص (اختياري)
│     └─ ui_unified.js    # Enhancer بسيط للتوحيد (اختياري)
└─ tools/
   ├─ serve.bat           # تشغيل سيرفر محلي (Windows)
   ├─ serve.sh            # تشغيل سيرفر محلي (Mac/Linux)
   └─ build_single.py     # إخراج نسخة ملف واحد للنشر
```

---

## 4) كيف يعمل التحميل والتشغيل؟ (Boot Sequence)
1) `index.html` يحتوي **Shell** + أماكن إدراج (slots) للمكونات والصفحات.
2) `bootstrap.js` يقوم بـ:
   - تحميل `components/nav.html` و `components/modals.html`
   - تحميل جميع ملفات `pages/*.html` وحقنها داخل الصفحة
   - بعد اكتمال الـ DOM، يقوم بتحميل `app.js`
3) `app.js` يقوم بتهيئة النظام، قراءة البيانات من التخزين، ثم إظهار الصفحة الافتراضية عبر `showView(id)`.

> **مهم:** لأن `bootstrap.js` يستخدم `fetch()`، لن يعمل المشروع عبر `file://`.

---

## 5) التشغيل الصحيح (محليًا)
### الطريقة الموصى بها
شغّل سيرفر محلي داخل مجلد المشروع (نفس مكان `index.html`):

- Windows:
  - `py -m http.server 5500`
- Mac/Linux:
  - `python3 -m http.server 5500`

ثم افتح:
- `http://127.0.0.1:5500/index.html`

> إذا كان 5500 مشغولًا استخدم منفذ آخر.

---

## 6) البيانات والنسخ الاحتياطي (JSON)
### التخزين
- التخزين الرئيسي للبيانات يتم في `localStorage`.
- المفتاح الأساسي للبيانات (Dataset) في هذا الإصدار:
  - `re_data_v2`

### النسخ الاحتياطي
- **Export JSON**: تصدير نسخة احتياطية.
- **Import JSON**: استيراد نسخة احتياطية.

### تنبيه مهم جدًا
`localStorage` مرتبط بالـ **Origin** (protocol + domain + port). مثال:
- `http://127.0.0.1:5500` ≠ `http://localhost:5500`
- تغيير العنوان/المنفذ قد يجعلك تشعر أن البيانات اختفت.

---

## 7) الوضع الليلي (Dark Mode)
تم تجميع قواعد الدارك في `assets/css/app.css` لتغطي:
- الكروت والجداول
- الأزرار
- حقول الإدخال (`input/textarea/select`)
- القوائم المنسدلة وخياراتها (`option/optgroup`) قدر الإمكان

> ملاحظة: بعض أنظمة التشغيل تتحكم جزئيًا بشكل قائمة الـ select (scrollbar وغيره)، لكن تم ضمان وضوح النص والخلفية.

---

## 8) الطباعة (Notices) – عربي + إنجليزي
### تنسيق الطباعة الحالي
- عند تفعيل الإنجليزية، يتم إخراج الخطاب بصيغة **عمودين**:
  - عربي (يمين)
  - English (يسار)

### ضبط الـ Margins
تم ضبط قواعد الطباعة داخل `app.css`، ومن ضمنها:
- `@page { size: A4; margin: 6mm; }`

**إعدادات كروم الموصى بها عند الطباعة/حفظ PDF:**
- More settings → **Margins: None**
- Scale: **100%**

---

## 9) قواعد التطوير (حتى لا يعود تداخل الأكواد)
- **CSS:** لا تُنشئ ملفات CSS جديدة. عدّل فقط `assets/css/app.css`.
- **JS:** عدّل فقط `assets/js/app.js`، ويفضل إبقاء الدوال المستخدمة في الـ HTML متاحة على `window.*` إذا كانت مرتبطة بـ `onclick`.
- إذا احتجت مكون مشترك جديد: ضعه في `components/` ثم حمّله عبر `bootstrap.js`.

---

## 10) إخراج نسخة ملف واحد للنشر (NAS Friendly)
لرفع نسخة واحدة سهلة على الـ NAS:

- شغّل:
  - `python tools/build_single.py`
- الناتج:
  - `dist/index_single.html`

هذه النسخة لا تعتمد على `fetch()` لملفات خارجية (كل شيء داخل ملف واحد).

---

## 11) Troubleshooting
- **صفحة لا تفتح / صفحة فارغة:** تأكد أنك تعمل عبر `http://` وليس `file://`.
- **Failed to fetch / 404 pages/components:** شغّل السيرفر من نفس مجلد `index.html`.
- **التغييرات لا تظهر:** نفّذ Hard Refresh (`Ctrl + F5`) أو افتح Incognito.
- **اختفاء البيانات:** غالبًا تغيّر الـ Origin (localhost vs 127.0.0.1 أو تغيير المنفذ).

---

## 12) سجل مختصر للتحديثات (UIV)
- **UIV10:** إصلاح `markDraftPrint()` للطباعة التجريبية.
- **UIV11:** طباعة ثنائية اللغة بتنسيق عمودين + حدود أكبر.
- **UIV12:** ضبط Margins للطباعة + تحسينات إضافية لثبات Layout.
- **UIV13:** إصلاح زر طباعة السندات (Receipt) + ضبط أبعاد الطباعة.
- **UIV14:** إصلاح محاذاة نص English في طباعة العمودين.
- **UIV15:** توحيد أشرطة البحث/الفرز (Toolbars) وإيقاف سكربت التوحيد القديم عن إعادة لفّ (re-wrap) الـ UI الجديد.

